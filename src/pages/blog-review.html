<div class="container-lg py-5">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <div id="blog-content">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Related Posts Widget -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-link-45deg me-2"></i>Posts Relacionados
                    </h5>
                </div>
                <div class="card-body">
                    <div id="related-posts-list">
                        <!-- Related posts will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Share Widget -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-share me-2"></i>Compartilhar
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="shareOnFacebook()">
                            <i class="bi bi-facebook me-2"></i>Facebook
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="shareOnTwitter()">
                            <i class="bi bi-twitter me-2"></i>Twitter
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="shareOnWhatsApp()">
                            <i class="bi bi-whatsapp me-2"></i>WhatsApp
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="copyLink()">
                            <i class="bi bi-link-45deg me-2"></i>Copiar Link
                        </button>
                    </div>
                </div>
            </div>

            <!-- Newsletter Signup -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-envelope me-2"></i>Newsletter
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Receba as últimas novidades sobre autismo e TDAH</p>
                    <div class="input-group mb-3">
                        <input type="email" class="form-control" placeholder="Seu e-mail">
                        <button class="btn btn-outline-info" type="button">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Blog Post Styles */
.blog-post {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    overflow: hidden;
}

.blog-post-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3rem 2rem;
    text-align: center;
    position: relative;
}

.blog-post-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.1);
    z-index: 1;
}

.blog-post-header > * {
    position: relative;
    z-index: 2;
}

.blog-post-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    line-height: 1.2;
}

.blog-post-meta {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
}

.blog-post-meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    opacity: 0.9;
}

.blog-post-description {
    font-size: 1.2rem;
    line-height: 1.6;
    opacity: 0.95;
    max-width: 600px;
    margin: 0 auto;
}

.blog-post-content {
    padding: 3rem 2rem;
}

.blog-post-content h1,
.blog-post-content h2,
.blog-post-content h3,
.blog-post-content h4,
.blog-post-content h5,
.blog-post-content h6 {
    color: #2c3e50;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

.blog-post-content h1 { font-size: 2rem; }
.blog-post-content h2 { font-size: 1.75rem; }
.blog-post-content h3 { font-size: 1.5rem; }
.blog-post-content h4 { font-size: 1.25rem; }

.blog-post-content p {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #555;
    margin-bottom: 1.5rem;
}

.blog-post-content ul,
.blog-post-content ol {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
}

.blog-post-content li {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #555;
    margin-bottom: 0.5rem;
}

.blog-post-content blockquote {
    border-left: 4px solid #667eea;
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: #666;
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 0 8px 8px 0;
}

.blog-post-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 2rem 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.blog-post-content code {
    background: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: #e83e8c;
}

.blog-post-content pre {
    background: #2d3748;
    color: #e2e8f0;
    padding: 1.5rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 2rem 0;
}

.blog-post-content pre code {
    background: none;
    color: inherit;
    padding: 0;
}

/* Breadcrumb */
.breadcrumb {
    background: transparent;
    padding: 0;
    margin-bottom: 2rem;
}

.breadcrumb-item + .breadcrumb-item::before {
    color: #6c757d;
}

.breadcrumb-item a {
    color: #667eea;
    text-decoration: none;
    transition: color 0.2s ease;
}

.breadcrumb-item a:hover {
    color: #5a67d8;
    text-decoration: underline;
}

/* Related Posts */
.related-post-item {
    display: flex;
    align-items: start;
    padding: 1rem 0;
    border-bottom: 1px solid #f1f3f4;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
}

.related-post-item:hover {
    color: #667eea;
    text-decoration: none;
    transform: translateX(5px);
}

.related-post-item:last-child {
    border-bottom: none;
}

.related-post-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    margin-right: 1rem;
    flex-shrink: 0;
}

.related-post-content h6 {
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
    line-height: 1.3;
    font-weight: 600;
}

.related-post-date {
    font-size: 0.8rem;
    color: #6c757d;
}

/* Share Buttons */
.btn-outline-primary:hover {
    background-color: #3b5998;
    border-color: #3b5998;
}

.btn-outline-info:hover {
    background-color: #1da1f2;
    border-color: #1da1f2;
}

.btn-outline-success:hover {
    background-color: #25d366;
    border-color: #25d366;
}

/* Responsive */
@media (max-width: 991.98px) {
    .blog-post-header {
        padding: 2rem 1rem;
    }
    
    .blog-post-title {
        font-size: 2rem;
    }
    
    .blog-post-content {
        padding: 2rem 1rem;
    }
    
    .blog-post-meta {
        gap: 1rem;
    }
}

@media (max-width: 767.98px) {
    .blog-post-title {
        font-size: 1.75rem;
    }
    
    .blog-post-meta {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .blog-post-content p {
        font-size: 1rem;
    }
}
</style>

<script>
(function() {
    // Get the ID from params
    const id = core.params[0];
    
    if (id) {
        loadBlogPost(id);
    } else {
        showError('ID não encontrado. Por favor, verifique a URL.');
    }
    
    async function loadBlogPost(postId) {
        try {
            const response = await core.fetchAPI(`page-itens?filters[id][$eq]=${postId}`, 'GET');
            
            if (response.data && response.data.length > 0) {
                const post = response.data[0];
                renderBlogPost(post);
                loadRelatedPosts(post);
            } else {
                throw new Error('Nenhum conteúdo encontrado');
            }
        } catch (error) {
            console.error('Error fetching page:', error);
            showError('Erro ao carregar o conteúdo. Por favor, tente novamente mais tarde.');
        }
    }
    
    function renderBlogPost(post) {
        // Format the date
        const publishedDate = new Date(post.publishedAt).toLocaleDateString('pt-BR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Parse markdown content
        const parsedContent = marked.parse(post.post || '');

        // Create the HTML content
        const content = `
            <article class="blog-post">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Início</a></li>
                        <li class="breadcrumb-item"><a href="/blog-ads">Blog</a></li>
                        <li class="breadcrumb-item active" aria-current="page">${post.title}</li>
                    </ol>
                </nav>
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <a href="/blog-ads" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left me-2"></i>Voltar ao Blog
                    </a>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="shareOnFacebook()">
                            <i class="bi bi-facebook"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="shareOnTwitter()">
                            <i class="bi bi-twitter"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="shareOnWhatsApp()">
                            <i class="bi bi-whatsapp"></i>
                        </button>
                    </div>
                </div>
                
                <div class="blog-post-header">
                    <h1 class="blog-post-title">${post.title}</h1>
                    <div class="blog-post-meta">
                        <div class="blog-post-meta-item">
                            <i class="bi bi-calendar3"></i>
                            <span>${publishedDate}</span>
                        </div>
                        <div class="blog-post-meta-item">
                            <i class="bi bi-person"></i>
                            <span>Dra. Anizia</span>
                        </div>
                        <div class="blog-post-meta-item">
                            <i class="bi bi-tag"></i>
                            <span>${post.category || 'Geral'}</span>
                        </div>
                    </div>
                    ${post.description ? `<div class="blog-post-description">${post.description}</div>` : ''}
                </div>
                
                <div class="blog-post-content">
                    ${parsedContent}
                </div>
            </article>
        `;

        // Set the content
        core.setData('blog-content', content);
        
        // Update page title
        document.title = `${post.title} - Blog`;
    }
    
    async function loadRelatedPosts(currentPost) {
        try {
            const response = await core.fetchAPI('pages?populate[page_itens][populate]=imagem', 'GET');
            const page = response?.data?.find(item => item?.name === 'Blogs');
            
            if (page?.page_itens) {
                // Get posts from the same category or random posts
                let relatedPosts = page.page_itens
                    .filter(item => item.id !== currentPost.id)
                    .slice(0, 3);
                
                if (relatedPosts.length === 0) {
                    relatedPosts = page.page_itens.slice(0, 3);
                }
                
                renderRelatedPosts(relatedPosts);
            }
        } catch (error) {
            console.error('Error loading related posts:', error);
        }
    }
    
    function renderRelatedPosts(posts) {
        const html = posts.map(post => {
            const image = post?.imagem?.[0];
            const imageUrl = image?.formats?.small?.url || image?.url;
            const imageAlt = image?.alternativeText || post?.title;
            const publishedDate = new Date(post.publishedAt).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'short'
            });

            return `
                <a href="/blog-review/${post.id}/${core.helpers.slugify(post.title)}" class="related-post-item">
                    ${imageUrl ? `
                        <img src="${config.api.proxyUrl}${imageUrl}" class="related-post-image" alt="${imageAlt}">
                    ` : `
                        <div class="related-post-image bg-light d-flex align-items-center justify-content-center">
                            <i class="bi bi-image text-muted"></i>
                        </div>
                    `}
                    <div class="related-post-content">
                        <h6>${post.title}</h6>
                        <div class="related-post-date">${publishedDate}</div>
                    </div>
                </a>
            `;
        }).join('');

        core.setData('related-posts-list', html);
    }
    
    function showError(message) {
        const errorContent = `
            <div class="alert alert-warning" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
        core.setData('blog-content', errorContent);
        core.toast(message, 'error');
    }
})();

// Share functions
function shareOnFacebook() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareOnTwitter() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${title}`, '_blank');
}

function shareOnWhatsApp() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent(document.title);
    window.open(`https://wa.me/?text=${title}%20${url}`, '_blank');
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        core.toast('Link copiado para a área de transferência!', 'success');
    }).catch(() => {
        core.toast('Erro ao copiar link', 'error');
    });
}
</script>